<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Visitas</title>
    <!-- Iconos de Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Estilos CSS -->
    <style>
        /* Aplicar box-sizing globalmente */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Estilos generales */
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: rgba(13, 27, 42, 0.9); /* Azul oscuro con transparencia */
            color: #333;
            min-height: 100vh;
        }

        /* Encabezado */
        header {
            text-align: center;
            padding: 50px 20px;
            color: #E0E1DD;
            background-color: rgba(0, 0, 0, 0.7);
        }

        header h1 {
            font-size: 3em;
            margin: 0;
            animation: fadeIn 2s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
        }

        /* Contenedor principal */
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
            animation: slideIn 1s ease-in-out;
        }

        /* Formulario */
        form {
            background-color: rgba(249, 249, 249, 0.95); /* Fondo claro con ligera transparencia */
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); /* Efecto 3D */
            color: #333;
            margin-bottom: 50px;
        }

        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        form input,
        form select,
        form textarea {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px; /* Esquinas redondeadas */
            font-size: 16px;
            background-color: #fff;
            color: #333;
            transition: border-color 0.3s ease;
        }

        form input:focus,
        form select:focus,
        form textarea:focus {
            outline: none;
            border-color: #1B263B;
        }

        /* Ajustes espec√≠ficos para los campos solicitados */

        /* 1. Ajustar los campos de visitantes extra */
        .visitor-row {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px; /* Espaciado entre elementos */
            flex-wrap: nowrap; /* Evita que los elementos se envuelvan en pantallas grandes */
        }

        .visitor-row input {
            flex: 1 1 auto; /* Permite que el campo tome el espacio disponible */
            padding: 10px 15px;
            font-size: 16px;
            min-width: 0; /* Evita que el input se expanda m√°s all√° del contenedor */
        }

        .visitor-buttons {
            display: flex;
            gap: 5px;
        }

        .visitor-row button {
            flex: 0 0 auto; /* Mantiene los botones en tama√±o fijo */
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 8px; /* Esquinas redondeadas */
            color: #E0E1DD;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 40px; /* Reducir el tama√±o de los botones */
            height: 40px; /* Mantener una altura consistente */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visitor-row button.add-visitor-btn {
            background-color: #006400; /* Verde oscuro */
        }

        .visitor-row button.remove-visitor-btn {
            background-color: #8B0000; /* Rojo borde */
        }

        /* 2. Ajustar el campo de "Motivo de Visita" */
        #reason {
            resize: vertical; /* Permite ajustar verticalmente el tama√±o */
            min-height: 80px; /* Altura m√≠nima */
            max-height: 200px; /* Altura m√°xima para evitar desbordamientos */
        }

        /* Botones */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas peque√±as */
        }

        .button-group button {
            padding: 15px 30px;
            font-size: 16px;
            border: 2px solid #1B263B;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #F9F9F9;
            color: #1B263B;
            flex: 1 1 auto; /* Permite que los botones crezcan o se reduzcan seg√∫n el espacio disponible */
            max-width: 200px; /* Limita el ancho m√°ximo para evitar desbordamientos */
        }

        .button-group .selected {
            background-color: #1B263B;
            color: #E0E1DD;
        }

        /* Efecto hover personalizado para botones de tipo de visita */
        #contact-presencial:hover {
            background-color: rgba(0, 109, 119, 0.8); /* Mismo color que el contador presencial */
            color: #E0E1DD;
        }

        #contact-telefonico:hover {
            background-color: rgba(29, 53, 87, 0.8); /* Mismo color que el contador telef√≥nico */
            color: #E0E1DD;
        }

        /* Checkbox personalizado */
        #checkbox-caja {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        #checkbox-caja label {
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        #checkbox-caja input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-left: 10px;
            accent-color: #1B263B;
        }

        /* Tooltip para visitantes adicionales */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: auto;
            background-color: #E0E1DD;
            color: #0D1B2A;
            text-align: center;
            padding: 5px;
            border: 1px solid #415A77;
            border-radius: 5px;
            position: absolute;
            z-index: 1;
            top: -5px;
            left: 105%;
            white-space: nowrap;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
        }

        /* Campos de fecha, hora y motivo de visita */
        .date-time-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 18px;
            gap: 20px;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas peque√±as */
        }

        .date-time-container label {
            margin-right: 10px;
            font-size: 16px;
            font-family: 'Roboto', Arial, sans-serif; /* Misma fuente que el nombre del visitante */
            color: #333;
        }

        .date-time-container input,
        textarea {
            width: 150px;
            padding: 5px;
            font-size: 16px;
            font-family: 'Roboto', Arial, sans-serif; /* Misma fuente que el nombre del visitante */
            background-color: #fff;
            border: 1px solid #ccc;
            color: #333;
            border-radius: 8px;
        }

        /* T√≠tulo del historial de visitas */
        h2 {
            color: #E0E1DD;
            text-align: center;
            margin-top: 50px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        /* Tabla */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: rgba(249, 249, 249, 0.95); /* Fondo claro con transparencia */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Efecto 3D */
            animation: fadeIn 1.5s ease-in-out;
        }

        table th, table td {
            padding: 15px;
            border-bottom: 1px solid #ccc;
            color: #333;
        }

        /* Alinear centrado todas las columnas excepto "Visitantes" */
        table th:not(:first-child),
        table td:not(:first-child) {
            text-align: center;
        }

        /* "Visitantes" alineado a la izquierda */
        table th:first-child,
        table td:first-child {
            text-align: left;
        }

        table th {
            background-color: #1B263B;
            color: #E0E1DD;
            font-weight: bold;
        }

        table tr:hover {
            background-color: #e0e0e0;
        }

        /* Fila derivada */
        .row-checked {
            background-color: #d4edda !important;
        }

        /* Botones de acci√≥n en la tabla */
        .actions button {
            padding: 10px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #E0E1DD;
        }

        .actions .derivado-btn {
            background-color: #FFD166; /* Amarillo */
            color: #333;
        }

        .actions .derivado-btn.checked {
            background-color: #06D6A0; /* Verde */
            color: #fff;
        }

        .actions .delete-btn {
            background-color: #EF476F; /* Rojo */
            color: #fff;
        }

        .actions button:hover {
            opacity: 0.8;
        }

        /* Filtros */
        .filters {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }

        .filters input,
        .filters select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: calc(20% - 10px);
            font-size: 16px;
            background-color: #fff;
            color: #333;
        }

        .filters input:focus,
        .filters select:focus {
            outline: none;
            border-color: #1B263B;
        }

        .filters .clear-filters-btn {
            padding: 10px 20px;
            background-color: #FF5733; /* Color distintivo */
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .filters .clear-filters-btn:hover {
            background-color: #C70039;
        }

        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 10px 20px;
            background-color: #1B263B;
            color: #E0E1DD;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            color: #666;
        }

        .pagination select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            background-color: #fff;
            color: #333;
        }

        /* Contadores de visitas */
        #visit-counter {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            font-size: 1.2em;
            color: #E0E1DD;
        }

        #visit-counter div {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            width: 45%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Efecto 3D */
        }

        #visit-counter .presencial-counter {
            background-color: rgba(0, 109, 119, 0.8); /* Verde oscuro */
        }

        #visit-counter .telefonico-counter {
            background-color: rgba(29, 53, 87, 0.8); /* Azul oscuro */
        }

        /* Iconos de los contadores */
        #visit-counter i {
            font-size: 1.5em;
        }

        /* Botones de exportar e importar */
        #import-export-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
            gap: 20px;
            flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas peque√±as */
        }

        #import-export-container button {
            padding: 15px 30px;
            background-color: #1E90FF; /* Azul para Exportar */
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Efecto 3D */
            flex: 1 1 auto; /* Permite que los botones crezcan o se reduzcan seg√∫n el espacio disponible */
            max-width: 200px; /* Limita el ancho m√°ximo para evitar desbordamientos */
        }

        #import-export-container button#import-btn {
            background-color: #32CD32; /* Verde para Importar */
        }

        #import-export-container button:hover {
            opacity: 0.8;
        }

        /* Transiciones y Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Estilos para m√≥viles */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2em;
            }

            form {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
                max-width: none; /* Permite que el bot√≥n tome todo el ancho disponible */
            }

            .visitor-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .visitor-buttons {
                justify-content: flex-start;
                margin-top: 5px;
            }

            .visitor-row button {
                margin-left: 0;
                margin-top: 0;
                width: 40px;
                height: 40px;
            }

            .date-time-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .filters input,
            .filters select {
                width: 100%;
            }

            #visit-counter {
                flex-direction: column;
                align-items: center;
            }

            #visit-counter div {
                width: 80%;
                margin-bottom: 10px;
            }

            .pagination {
                flex-direction: column;
            }

            .pagination select {
                width: 100%;
            }

            #import-export-container {
                flex-direction: column;
            }

            #import-export-container button {
                width: 100%;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Registro de Visitas</h1>
    </header>

    <div class="container">
        <!-- Contadores de visitas -->
        <div id="visit-counter">
            <div class="presencial-counter">
                <i class="fas fa-user"></i> Presencial: <span id="presencial-counter">0</span>
            </div>
            <div class="telefonico-counter">
                <i class="fas fa-phone"></i> Telef√≥nica: <span id="telefonico-counter">0</span>
            </div>
        </div>

        <!-- Formulario -->
        <form id="visit-form">
            <div class="button-group">
                <button type="button" id="contact-presencial" class="selected">
                    <i class="fas fa-user"></i> Presencial
                </button>
                <button type="button" id="contact-telefonico">
                    <i class="fas fa-phone"></i> Telef√≥nico
                </button>
            </div>
            <input type="hidden" id="contact-method" name="contact-method" required>

            <label for="name">Nombre del Visitante:</label>
            <div class="visitor-row">
                <input type="text" id="name" placeholder="Ingrese el nombre del visitante" required>
                <div class="visitor-buttons">
                    <button type="button" class="add-visitor-btn" title="A√±adir Visitante Extra"><i class="fas fa-plus"></i></button>
                    <button type="button" class="remove-visitor-btn" title="Eliminar Visitante Extra"><i class="fas fa-minus"></i></button>
                </div>
            </div>
            <div id="additional-visitors"></div>

            <label for="area">√Årea a Visitar:</label>
            <select id="area" name="area" required>
                <option value="">Seleccione un √°rea</option>
                <option value="Caja">Caja</option>
                <option value="Recepci√≥n">Recepci√≥n</option>
                <option value="Legales">Legales</option>
                <option value="Gerencia">Gerencia</option>
                <option value="Producci√≥n">Producci√≥n</option>
                <option value="Administraci√≥n de Cliente">Administraci√≥n de Cliente</option>
                <option value="RRHH">RRHH</option>
                <option value="Comercial/Broker">Comercial/Broker</option>
                <option value="Transformaci√≥n Digital">Transformaci√≥n Digital</option>
                <option value="T√©cnica">T√©cnica</option>
                <option value="Cuentas a Pagar">Cuentas a Pagar</option>
                <option value="Tesorer√≠a">Tesorer√≠a</option>
                <option value="Contratos">Contratos</option>
                <option value="Compras y Log√≠stica">Compras y Log√≠stica</option>
                <option value="Contabilidad">Contabilidad</option>
                <option value="Marketing">Marketing</option>
                <option value="Instrumentaci√≥n">Instrumentaci√≥n</option>
            </select>

            <!-- Contenedores condicionales -->
            <div id="checkbox-caja" style="display: none;">
                <label for="check-caja">
                    ¬øTiene turno?
                    <input type="checkbox" id="check-caja" name="checkCaja">
                </label>
            </div>

            <div id="vendedores-container" style="display: none;">
                <label for="vendedores">Vendedor a Visitar:</label>
                <select id="vendedores" name="vendedores">
                    <option value="">Seleccione un vendedor</option>
                    <option value="Ana Valles">Ana Valles</option>
                    <option value="Lorena Gaitan">Lorena Gaitan</option>
                    <option value="Juan Misakian">Juan Misakian</option>
                    <option value="Diego Funes">Diego Funes</option>
                    <option value="Maximiliano Heredia">Maximiliano Heredia</option>
                    <option value="Rocio Cuesta">Rocio Cuesta</option>
                    <option value="Lucas Giacobino">Lucas Giacobino</option>
                    <option value="Jorgelina Falibene">Jorgelina Falibene</option>
                    <option value="Barbara Revello(Broker)">Barbara Revello(Broker)</option>
                    <option value="Luciano Rigoni(Broker)">Luciano Rigoni(Broker)</option>
                    <option value="Cristian Buzzetti">Cristian Buzzetti</option>
                </select>
            </div>

            <div id="persona-visitar-container" style="display: none;">
                <label for="persona-visitar">Persona a Visitar:</label>
                <input type="text" id="persona-visitar" name="personaVisitar" placeholder="Ingrese el nombre de la persona">
            </div>

            <label for="reason">Motivo de la Visita:</label>
            <textarea id="reason" rows="4" placeholder="Describa el motivo de la visita"></textarea>

            <div class="date-time-container">
                <label for="visit-date">Fecha</label>
                <input type="date" id="visit-date" required>
                <label for="visit-time">Hora</label>
                <input type="time" id="visit-time" required>
            </div>

            <div class="button-group">
                <button type="submit" class="save-visit-btn">
                    <i class="fas fa-save"></i> Guardar Visita
                </button>
            </div>
        </form>

        <!-- Historial de visitas -->
        <h2>Historial de Visitas</h2>
        <div class="filters">
            <input type="text" id="search-input" placeholder="üîçÔ∏é Buscar...">
            <select id="area-filter">
                <option value="">√Årea</option>
                <option value="Caja">Caja</option>
                <option value="Recepci√≥n">Recepci√≥n</option>
                <option value="Legales">Legales</option>
                <option value="Gerencia">Gerencia</option>
                <option value="Producci√≥n">Producci√≥n</option>
                <option value="Administraci√≥n de Cliente">Administraci√≥n de Cliente</option>
                <option value="RRHH">RRHH</option>
                <option value="Comercial/Broker">Comercial/Broker</option>
                <option value="Transformaci√≥n Digital">Transformaci√≥n Digital</option>
                <option value="T√©cnica">T√©cnica</option>
                <option value="Cuentas a Pagar">Cuentas a Pagar</option>
                <option value="Tesorer√≠a">Tesorer√≠a</option>
                <option value="Contratos">Contratos</option>
                <option value="Compras y Log√≠stica">Compras y Log√≠stica</option>
                <option value="Contabilidad">Contabilidad</option>
                <option value="Marketing">Marketing</option>
                <option value="Instrumentaci√≥n">Instrumentaci√≥n</option>
            </select>
            <select id="turno-filter">
                <option value="">Turno</option>
                <option value="SI">S√≠</option>
                <option value="NO">No</option>
                <option value="NULL">No aplica</option>
            </select>
            <select id="derivado-filter">
                <option value="">Derivado</option>
                <option value="SI">S√≠</option>
                <option value="NO">No</option>
            </select>
            <button class="clear-filters-btn">Limpiar filtros</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Visitantes</th>
                    <th>√Årea</th>
                    <th>Persona a Visitar</th>
                    <th>Motivo</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Contacto</th>
                    <th>Turno</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="visit-table-body">
                <!-- Filas de visitas -->
            </tbody>
        </table>

        <!-- Paginaci√≥n -->
        <div class="pagination">
            <button id="prevPage" disabled>‚óÄ Anterior</button>
            <select id="page-selector"></select>
            <button id="nextPage" disabled>Siguiente ‚ñ∂</button>
        </div>

        <!-- Botones de exportaci√≥n e importaci√≥n -->
        <div id="import-export-container">
            <button id="export-btn" class="export-btn"><i class="fas fa-file-export"></i> Exportar a XLSX</button>
            <input type="file" id="import-input" accept=".xlsx" style="display: none;">
            <button id="import-btn"><i class="fas fa-file-import"></i> Importar desde XLSX</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script>
        let visitHistory = [];
        let contactMethod = 'presencial';
        let currentPage = 1;
        let totalPages = 1;
        const visitsPerPage = 10;
        const BACKUP_INTERVAL = 5 * 60 * 1000; // 5 minutos en milisegundos

        // Cargar historial de visitas desde localStorage
        function loadVisitHistory() {
            const savedHistory = localStorage.getItem('visitHistory');
            if (savedHistory) {
                visitHistory = JSON.parse(savedHistory);
            }
            displayVisits();
            updateCounters();
        }

        // Guardar historial de visitas en localStorage
        function saveVisitHistory() {
            localStorage.setItem('visitHistory', JSON.stringify(visitHistory));
        }

        // Manejar selecci√≥n de m√©todo de contacto
        document.getElementById('contact-presencial').addEventListener('click', () => {
            contactMethod = 'presencial';
            document.getElementById('contact-presencial').classList.add('selected');
            document.getElementById('contact-telefonico').classList.remove('selected');
            document.getElementById('contact-method').value = 'presencial';
        });

        document.getElementById('contact-telefonico').addEventListener('click', () => {
            contactMethod = 'telefonico';
            document.getElementById('contact-telefonico').classList.add('selected');
            document.getElementById('contact-presencial').classList.remove('selected');
            document.getElementById('contact-method').value = 'telefonico';
        });

        // Manejar botones de a√±adir y quitar visitantes
        const addVisitorBtn = document.querySelector('.add-visitor-btn');
        const removeVisitorBtn = document.querySelector('.remove-visitor-btn');
        const additionalVisitors = document.getElementById('additional-visitors');

        addVisitorBtn.addEventListener('click', () => {
            const newVisitorInput = document.createElement('input');
            newVisitorInput.type = 'text';
            newVisitorInput.className = 'visitor-input';
            newVisitorInput.placeholder = 'Nombre del Visitante';
            newVisitorInput.required = true;
            additionalVisitors.appendChild(newVisitorInput);
        });

        removeVisitorBtn.addEventListener('click', () => {
            const lastVisitorInput = additionalVisitors.lastElementChild;
            if (lastVisitorInput && lastVisitorInput.tagName === 'INPUT') {
                additionalVisitors.removeChild(lastVisitorInput);
            }
        });

        // Obtener la fecha y hora actual
        function getCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-AR', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
            return timeString;
        }

        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            let month = (now.getMonth() + 1).toString(); 
            let day = now.getDate().toString();

            if (month.length === 1) {
                month = '0' + month;
            }
            if (day.length === 1) {
                day = '0' + day;
            }

            const dateString = `${year}-${month}-${day}`;
            return dateString;
        }

        // Manejar cambios en el √°rea seleccionada
        const areaSelect = document.getElementById('area');
        const checkboxCaja = document.getElementById('checkbox-caja');
        const vendedoresContainer = document.getElementById('vendedores-container');
        const personaVisitarContainer = document.getElementById('persona-visitar-container');

        function toggleElements() {
            const selectedArea = areaSelect.value;

            checkboxCaja.style.display = 'none';
            vendedoresContainer.style.display = 'none';
            personaVisitarContainer.style.display = 'none';

            if (selectedArea === 'Caja') {
                checkboxCaja.style.display = 'flex';
            } else if (selectedArea === 'Comercial/Broker') {
                vendedoresContainer.style.display = 'block';
            } else if (selectedArea !== '') {
                personaVisitarContainer.style.display = 'block';
            }
        }

        areaSelect.addEventListener('change', toggleElements);

        // A√±adir visita al historial
        function addVisitToHistory(visit) {
            visit.id = Date.now(); // A√±adir un ID √∫nico
            visitHistory.push(visit);
            saveVisitHistory();
            displayVisits(); // Muestra la tabla con los registros
            updateCounters();
        }

        // Actualizar contadores de visitas
        function updateCounters() {
            const presencialCounter = document.getElementById('presencial-counter');
            const telefonicoCounter = document.getElementById('telefonico-counter');
            const presencialCount = visitHistory.filter(visit => visit.contact === 'üë§').length;
            const telefonicoCount = visitHistory.filter(visit => visit.contact === '‚òé').length;
            presencialCounter.textContent = presencialCount;
            telefonicoCounter.textContent = telefonicoCount;
        }

        // Mostrar visitas en la tabla
        function displayVisits(page = 1, searchTerm = '') {
            const areaFilter = document.getElementById('area-filter').value;
            const turnoFilter = document.getElementById('turno-filter').value;
            const derivadoFilter = document.getElementById('derivado-filter').value;

            const filteredVisits = visitHistory.filter(visit => {
                const matchesSearch = Object.values(visit).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
                );

                const matchesArea = areaFilter === '' || visit.area === areaFilter;

                const matchesTurno = turnoFilter === '' || 
                    (turnoFilter === 'SI' && visit.tieneTurno === true) ||
                    (turnoFilter === 'NO' && visit.tieneTurno === false) ||
                    (turnoFilter === 'NULL' && visit.tieneTurno === null);

                const matchesDerivado = derivadoFilter === '' || 
                    (derivadoFilter === 'SI' && visit.derivado === true) ||
                    (derivadoFilter === 'NO' && visit.derivado === false);

                return matchesSearch && matchesArea && matchesTurno && matchesDerivado;
            });

            totalPages = Math.ceil(filteredVisits.length / visitsPerPage);

            const start = (page - 1) * visitsPerPage;
            const end = start + visitsPerPage;
            // Invierte el array para mostrar el √∫ltimo registro primero
            const visitsToDisplay = filteredVisits.slice().reverse().slice(start, end);

            const visitTableBody = document.getElementById('visit-table-body');
            visitTableBody.innerHTML = '';

            visitsToDisplay.forEach((visit) => {
                const row = document.createElement('tr');
                const [year, month, day] = visit.date.split('-');
                const formattedDate = `${day}-${month}-${year}`;
                const visitorsText = visit.visitors.length > 1 
                    ? `<span class="tooltip">${visit.visitors[0]} <strong>+${visit.visitors.length - 1}</strong>
                        <span class="tooltiptext">${visit.visitors.slice(1).join(', ')}</span>
                      </span>`
                    : visit.visitors[0];

                row.innerHTML = 
                    `<td>${visitorsText}</td>
                    <td>${visit.area}</td>
                    <td>${visit.personaVisitar || visit.vendedor || '-'}</td>
                    <td>${visit.reason}</td>
                    <td>${formattedDate}</td>
                    <td>${visit.time}</td>
                    <td>${visit.contact}</td>
                    <td>${visit.area === 'Caja' ? (visit.tieneTurno ? '‚úîÔ∏è' : '‚ùå') : '‚ûñ'}</td>
                    <td class="actions">
                        <button class="derivado-btn ${visit.derivado ? 'checked' : ''}" onclick="markAsDerivado(${visit.id}, this)">
                            ${visit.derivado ? '<i class="fas fa-check"></i>' : 'Derivar'}
                        </button>
                        <button class="delete-btn" onclick="deleteVisit(${visit.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>`
                ;
                if (visit.derivado) {
                    row.classList.add('row-checked');
                }
                visitTableBody.appendChild(row);
            });

            document.getElementById('prevPage').disabled = page === 1;
            document.getElementById('nextPage').disabled = page === totalPages || totalPages === 0;

            // Actualizar selector de p√°ginas
            const pageSelector = document.getElementById('page-selector');
            pageSelector.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `P√°gina ${i}`;
                if (i === page) {
                    option.selected = true;
                }
                pageSelector.appendChild(option);
            }

            currentPage = page;
        }

        // Marcar como derivado
        function markAsDerivado(id, button) {
            const visitIndex = visitHistory.findIndex(visit => visit.id === id);
            if (visitIndex !== -1) {
                visitHistory[visitIndex].derivado = !visitHistory[visitIndex].derivado;
                saveVisitHistory();
                displayVisits(currentPage);

                // Actualizar bot√≥n y fila
                if (visitHistory[visitIndex].derivado) {
                    button.classList.add('checked');
                    button.innerHTML = '<i class="fas fa-check"></i>';
                } else {
                    button.classList.remove('checked');
                    button.innerHTML = 'Derivar';
                }
            }
        }

        // Eliminar visita
        function deleteVisit(id) {
            const visitIndex = visitHistory.findIndex(visit => visit.id === id);
            if (visitIndex !== -1) {
                visitHistory.splice(visitIndex, 1);
                saveVisitHistory();
                displayVisits(currentPage);
                updateCounters();
            }
        }

        // Manejar el env√≠o del formulario
        const form = document.getElementById('visit-form');
        form.addEventListener('submit', (event) => {
            event.preventDefault();

            if (!contactMethod) {
                alert('Por favor, seleccione el tipo de contacto (Presencial o Telef√≥nico)');
                return;
            }

            const nameInput = document.getElementById('name');
            const additionalVisitorsInputs = document.querySelectorAll('.visitor-input');
            const areaInput = document.getElementById('area');
            const reasonInput = document.getElementById('reason');
            const dateInput = document.getElementById('visit-date');
            const timeInput = document.getElementById('visit-time');
            const checkCaja = document.getElementById('check-caja');
            const vendedoresSelect = document.getElementById('vendedores');
            const personaVisitarInput = document.getElementById('persona-visitar');

            const visitors = [nameInput.value];
            additionalVisitorsInputs.forEach(input => {
                if (input.value) {
                    visitors.push(input.value);
                }
            });

            const visit = {
                visitors: visitors,
                area: areaInput.value,
                reason: reasonInput.value,
                date: dateInput.value,
                time: timeInput.value,
                contact: contactMethod === 'presencial' ? 'üë§' : '‚òé',
                derivado: false,
                tieneTurno: areaInput.value === 'Caja' ? checkCaja.checked : null,
                vendedor: areaInput.value === 'Comercial/Broker' ? vendedoresSelect.value : null,
                personaVisitar: (areaInput.value !== 'Caja' && areaInput.value !== 'Comercial/Broker' && areaInput.value !== '') ? personaVisitarInput.value : null
            };

            addVisitToHistory(visit);

            form.reset();
            additionalVisitors.innerHTML = '';

            dateInput.value = getCurrentDate();
            timeInput.value = getCurrentTime();

            // Resetear la selecci√≥n de contacto
            contactMethod = 'presencial';
            document.getElementById('contact-presencial').classList.add('selected');
            document.getElementById('contact-telefonico').classList.remove('selected');
            document.getElementById('contact-method').value = 'presencial';
        });

        // Manejar paginaci√≥n
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                displayVisits(currentPage - 1);
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage < totalPages) {
                displayVisits(currentPage + 1);
            }
        });

        document.getElementById('page-selector').addEventListener('change', (event) => {
            displayVisits(parseInt(event.target.value));
        });

        // Funci√≥n para exportar a XLSX
        function exportToXLSX() {
            const headers = ['Visitantes', '√Årea', 'Persona a Visitar', 'Motivo', 'Fecha', 'Hora', 'Contacto', 'Turno', 'Derivado'];
            const data = [
                headers,
                ...visitHistory.map(visit => [
                    visit.visitors.join('; '),
                    visit.area,
                    visit.personaVisitar || visit.vendedor || '-',
                    visit.reason,
                    visit.date,
                    visit.time,
                    visit.contact,
                    visit.tieneTurno === null ? 'N/A' : (visit.tieneTurno ? 'S√≠' : 'No'),
                    visit.derivado ? 'S√≠' : 'No'
                ])
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Historial de Visitas");

            // Autoajustar ancho de columnas
            const wscols = data[0].map((_, i) => ({
                wch: Math.max(...data.map(row => row[i] ? row[i].toString().length : 0))
            }));
            ws['!cols'] = wscols;

            XLSX.writeFile(wb, 'historial_visitas.xlsx');
        }

        // Funci√≥n para importar desde XLSX
        function importFromXLSX(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                const headers = jsonData[0];
                const newVisits = jsonData.slice(1).map(row => {
                    return {
                        visitors: row[0].split('; '),
                        area: row[1],
                        personaVisitar: row[2] !== '-' ? row[2] : null,
                        reason: row[3],
                        date: row[4],
                        time: row[5],
                        contact: row[6],
                        tieneTurno: row[7] === 'N/A' ? null : (row[7] === 'S√≠'),
                        derivado: row[8] === 'S√≠',
                        id: Date.now() + Math.random() // A√±adir un ID √∫nico
                    };
                });

                visitHistory = [...visitHistory, ...newVisits];
                saveVisitHistory();
                displayVisits();
                updateCounters();
            };
            reader.readAsArrayBuffer(file);
        }

        // Manejar exportaci√≥n e importaci√≥n
        document.getElementById('export-btn').addEventListener('click', exportToXLSX);
        
        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-input').click();
        });

        document.getElementById('import-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                importFromXLSX(file);
            }
        });

        // Cargar historial y configurar eventos al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            loadVisitHistory();
            displayVisits();
            updateCounters();

            document.getElementById('visit-date').value = getCurrentDate();
            document.getElementById('visit-time').value = getCurrentTime();

            const searchInput = document.getElementById('search-input');
            const areaFilter = document.getElementById('area-filter');
            const turnoFilter = document.getElementById('turno-filter');
            const derivadoFilter = document.getElementById('derivado-filter');
            const clearFiltersBtn = document.querySelector('.clear-filters-btn');

            searchInput.addEventListener('input', () => {
                displayVisits(1, searchInput.value);
            });

            areaFilter.addEventListener('change', () => {
                displayVisits(1, searchInput.value);
            });

            turnoFilter.addEventListener('change', () => {
                displayVisits(1, searchInput.value);
            });

            derivadoFilter.addEventListener('change', () => {
                displayVisits(1, searchInput.value);
            });

            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                areaFilter.value = '';
                turnoFilter.value = '';
                derivadoFilter.value = '';
                displayVisits(1);
            });

            // Respaldo autom√°tico
            setInterval(saveVisitHistory, BACKUP_INTERVAL);
        });
    </script>
</body>
</html>


